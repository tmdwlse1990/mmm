icecastle,188,205,5	script	Fishing Spot	800,{

	// CONFIG
	.@rod_id = 1601; // คันเบ็ด
	setarray .@speed_gear[0], 2301, 2302, 2339; // อุปกรณ์เร่งตก
	setarray .@cast_time[0], 4, 3, 2, 1;

	.@normal_bait = 517; // เหยื่อธรรมดา
	.@special_bait = 516; // เหยื่อพิเศษ (เพิ่มอัตราของดี)

	// ของรางวัล + อัตรา
	setarray .@item_list[0], 501, 502, 503, 504;
	setarray .@base_chance[0], 50, 30, 15, 5;

	// ตรวจสอบคันเบ็ด
	if (getequipid(EQI_HAND_R) != .@rod_id) {
		mes "[Fishing Spot]";
		mes "คุณต้องใส่คันเบ็ดก่อน!";
		close;
	}

	// ตรวจสอบความเร็ว
	.@speed_lv = 0;
	for (.@i = 0; .@i < getarraysize(.@speed_gear); .@i++) {
		if (isequipped(.@speed_gear[.@i])) {
			.@speed_lv = .@i + 1;
			break;
		}
	}

	// ตรวจสอบจำนวนเหยื่อแต่ละชนิด
	.@normal_cnt = countitem(.@normal_bait);
	.@special_cnt = countitem(.@special_bait);

	if (.@normal_cnt + .@special_cnt == 0) {
		mes "[Fishing Spot]";
		mes "คุณไม่มีเหยื่อเลย!";
		close;
	}

	// เลือกชนิดเหยื่อ
	if (.@normal_cnt > 0 && .@special_cnt > 0) {
		.@bait_select = select("ใช้เหยื่อธรรมดา:ใช้เหยื่อพิเศษ");
	} else if (.@normal_cnt > 0) {
		.@bait_select = 1;
	} else if (.@special_cnt > 0) {
		.@bait_select = 2;
	}

	if (.@bait_select == 1) {
		.@bait_id = .@normal_bait;
		.@bait_count = .@normal_cnt;
	} else {
		.@bait_id = .@special_bait;
		.@bait_count = .@special_cnt;
	}

	mes "[Fishing Spot]";
	mes "คุณเลือกใช้เหยื่อ: " + getitemname(.@bait_id);
	mes "จำนวนเหยื่อที่ใช้ได้: ^00FF00" + .@bait_count + "^000000 ชิ้น";
	next;

	while (.@bait_count > 0) {

		delitem .@bait_id, 1;
		.@bait_count--;

		progressbar "0x00CCFF", .@cast_time[.@speed_lv];

		// เตรียมอัตราสุ่ม
		copyarray .@chance[0], .@base_chance, getarraysize(.@base_chance);
		if (.@bait_id == .@special_bait) {
			.@bonus = 20;
			.@chance[2] += .@bonus / 2;
			.@chance[3] += .@bonus / 2;
			.@chance[0] -= .@bonus / 2;
			.@chance[1] -= .@bonus / 2;
		}

		// สุ่มรางวัล
		.@roll = rand(1,100);
		.@total = 0;
		for (.@i = 0; .@i < getarraysize(.@item_list); .@i++) {
			.@total += .@chance[.@i];
			if (.@roll <= .@total) {
				.@item = .@item_list[.@i];
				break;
			}
		}

		specialeffect EF_REFINEOK;
		mes "คุณตกได้ ^0000FF" + getitemname(.@item) + "^000000!";
		getitem .@item, 1;

	}

	mes "[Fishing Spot]";
	mes "เหยื่อของคุณหมดแล้ว!";
	close;
}