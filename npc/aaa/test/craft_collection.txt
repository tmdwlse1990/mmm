// NPC คราฟของ Henry ช่างฝีมือ 1
icecastle,202,201,5	script	Henry ช่างฝีมือ	800,{
	mes "[Henry]";
	mes "อยากคราฟอะไรหรือเปล่า?";
	next;
	switch(select("Potion X","Weapon Y","Armor Z","Accessory A","ไม่เป็นไร")) {
		case 1: callsub S_CRAFT1, 1, 531,1, 2339; end;
		case 2: callsub S_CRAFT1, 2, 537,1, 2339; end;
		case 3: callsub S_CRAFT1, 3, 569,1, 2339; end;
		case 4: callsub S_CRAFT1, 4, 501,1, 2339; end;
		case 5: mes "[Henry]"; mes "ไว้คราวหน้า!"; close;
	}
	end;
	
S_CRAFT1:
	.@slot = getarg(0);
	.@item_id = getarg(1);
	.@item_count = getarg(2);
	.@output_item = getarg(3);

	// ตัวแปรอัตราสำเร็จเฉพาะของ NPC1
	switch(.@slot) {
		case 1: .@chance_var$ = "#CRAFT1_ITEM1_CHANCE"; break;
		case 2: .@chance_var$ = "#CRAFT1_ITEM2_CHANCE"; break;
		case 3: .@chance_var$ = "#CRAFT1_ITEM3_CHANCE"; break;
		case 4: .@chance_var$ = "#CRAFT1_ITEM4_CHANCE"; break;
	}

	.@success_rate = getd(.@chance_var$);
	if (.@success_rate == 0) setd(.@chance_var$, 30);
	.@success_rate = getd(.@chance_var$);

	.@item_name$ = getitemname(.@item_id);

	mes "[Henry]";
	mes "คราฟไอเท็มนี้โอกาสสำเร็จ " + .@success_rate + "%";
	mes "ใช้ ^0000FF" + .@item_name$ + "^000000 จำนวน " + .@item_count + " ชิ้น";

	if(countitem(.@item_id) < .@item_count) {
		mes "^FF0000คุณมีวัตถุดิบไม่พอ!^000000";
		close;
	}

	next;
	mes "เริ่มคราฟเลยไหม?";
	if(select("คราฟเลย!:ยังก่อน") == 2) close;

	delitem .@item_id, .@item_count;
	specialeffect EF_MAGICROD;
	progressbar_NPC "00CCFF", 3;

	if(rand(100) < .@success_rate) {
		specialeffect EF_REFINEOK;
		mes "[Henry]";
		mes "คราฟสำเร็จ!";
		getitem .@output_item, 1;
		setd(.@chance_var$, 30);
	} else {
		specialeffect EF_CLAYMORE;
		mes "[Henry]";
		mes "คราฟไม่สำเร็จ...";
		setd(.@chance_var$, .@success_rate + 5);
	}
	end;
}

// NPC คราฟของ Henry ช่างฝีมือ 2
icecastle,202,204,5	script	Henry ช่างฝีมือ2	800,{
	mes "[Henry]";
	mes "อยากคราฟอะไรไหม?";
	next;
	switch(select("Potion X","Weapon Y","Armor Z","Accessory A","ไม่เป็นไร")) {
		case 1: callsub S_CRAFT2, 1, 2, 537,1, 569,1, 2339; end;     // ใช้วัตถุดิบหลายชิ้น
		case 2: callsub S_CRAFT2, 2, 2, 501,1, 531,1, 2339; end;
		case 3: callsub S_CRAFT2, 3, 3, 502,1, 503,1, 504,1, 2339; end;
		case 4: callsub S_CRAFT2, 4, 1, 531,5, 2339; end;
		case 5: mes "[Henry]"; mes "ไว้คราวหน้า!"; close;
	}
	end;

S_CRAFT2:
	.@slot = getarg(0);
	.@req_count = getarg(1);
	.@arg_offset = 2;
	
	switch(.@slot) {
		case 1: .@chance_var$ = "#CRAFT2_ITEM1_CHANCE"; break;
		case 2: .@chance_var$ = "#CRAFT2_ITEM2_CHANCE"; break;
		case 3: .@chance_var$ = "#CRAFT2_ITEM3_CHANCE"; break;
		case 4: .@chance_var$ = "#CRAFT2_ITEM4_CHANCE"; break;
	}

	.@success_rate = getd(.@chance_var$);
	if (.@success_rate == 0) setd(.@chance_var$, 30);
	.@success_rate = getd(.@chance_var$);

	mes "[Henry]";
	mes "ต้องใช้วัตถุดิบดังนี้:";
	for(.@i = 0; .@i < .@req_count; .@i++) {
		.@id = getarg(.@arg_offset + .@i * 2);
		.@cnt = getarg(.@arg_offset + .@i * 2 + 1);
		.@name$ = getitemname(.@id);
		mes " ^0000FF" + .@name$ + "^000000 จำนวน " + .@cnt + " ชิ้น";

		if(countitem(.@id) < .@cnt) {
			mes "^FF0000คุณมีวัตถุดิบไม่พอ!^000000";
			close;
		}
	}

	.@output_item = getarg(.@arg_offset + .@req_count * 2);
	.@output_name$ = getitemname(.@output_item);

	mes "โอกาสสำเร็จ: ^00FF00" + .@success_rate + "%^000000";
	next;
	mes "จะเริ่มคราฟเลยไหม?";
	if(select("คราฟเลย!:ยังก่อน") == 2) close;

	for(.@i = 0; .@i < .@req_count; .@i++) {
		.@id = getarg(.@arg_offset + .@i * 2);
		.@cnt = getarg(.@arg_offset + .@i * 2 + 1);
		delitem .@id, .@cnt;
	}

	specialeffect EF_MAGICROD;
	progressbar_NPC "00CCFF", 3;

	if(rand(100) < .@success_rate) {
		specialeffect EF_REFINEOK;
		mes "[Henry]";
		mes "คราฟสำเร็จ!";
		mes "ได้รับ ^00FF00" + .@output_name$ + "^000000";
		getitem .@output_item, 1;
		setd(.@chance_var$, 30);
	} else {
		specialeffect EF_CLAYMORE;
		mes "[Henry]";
		mes "คราฟไม่สำเร็จ...";
		mes "ครั้งหน้าจะง่ายขึ้นอีก +5%";
		setd(.@chance_var$, .@success_rate + 5);
	}
	end;
}